<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Calendar Viewer</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FullCalendar -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>

    <!-- ical.js -->
    <script src='https://cdn.jsdelivr.net/npm/ical.js@1.5.0/build/ical.min.js'></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .fc .fc-toolbar-title {
            font-size: 1.2rem;
            font-weight: 600;
        }
        .fc .fc-button {
            background-color: #3b82f6;
            border-color: #3b82f6;
        }
        .fc .fc-button:hover {
            background-color: #2563eb;
            border-color: #2563eb;
        }
        .fc .fc-button-primary:not(:disabled).fc-button-active,
        .fc .fc-button-primary:not(:disabled):active {
            background-color: #1d4ed8;
            border-color: #1d4ed8;
        }
        .fc-event-title {
            font-weight: 500;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸ“… My Calendar</h1>
            <p class="text-gray-600">è‡ªå‹•çš„ã«ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’èª­ã¿è¾¼ã‚“ã§è¡¨ç¤ºã—ã¾ã™</p>
        </div>

        <!-- Auto Loading Indicator -->
        <div id="loading-indicator" class="mb-6 p-4 bg-blue-50 rounded-lg flex items-center justify-center gap-3">
            <div class="loading border-blue-600 border-t-transparent"></div>
            <span class="text-blue-800">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</span>
        </div>

        <!-- Settings Toggle Button -->
        <div class="mb-4 flex justify-end">
            <button
                onclick="toggleSettings()"
                class="text-gray-500 hover:text-gray-700 flex items-center gap-2 text-sm"
            >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                è¨­å®š
            </button>
        </div>

        <!-- Input Section (Hidden by default if URL is set) -->
        <div id="settings-panel" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-gray-800">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¨­å®š</h2>
                <button onclick="toggleSettings()" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Tab Navigation -->
            <div class="mb-6 border-b border-gray-200">
                <nav class="-mb-px flex space-x-8">
                    <button onclick="switchTab('url')" id="tab-url" class="tab-btn border-blue-500 text-blue-600 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                        ğŸ”— URLã‹ã‚‰èª­ã¿è¾¼ã¿
                    </button>
                    <button onclick="switchTab('paste')" id="tab-paste" class="tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                        ğŸ“‹ ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘
                    </button>
                    <button onclick="switchTab('file')" id="tab-file" class="tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                        ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                    </button>
                </nav>
            </div>

            <!-- URL Input Tab -->
            <div id="panel-url" class="tab-panel">
                <div class="mb-4">
                    <label for="calendar-url" class="block text-sm font-medium text-gray-700 mb-2">
                        Google Calendarã®å…¬é–‹URL
                    </label>
                    <input
                        type="url"
                        id="calendar-url"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono text-sm"
                        placeholder="https://calendar.google.com/calendar/ical/..."
                    >
                    <p class="mt-1 text-xs text-gray-500">
                        å…¬é–‹è¨­å®šã•ã‚Œã¦ã„ã‚‹Google Calendarã®ical URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
                    </p>
                </div>

                <div class="mb-4 p-3 bg-yellow-50 rounded-md">
                    <p class="text-xs text-yellow-800">
                        <strong>âš ï¸ æ³¨æ„ï¼š</strong>CORSåˆ¶é™ã‚’å›é¿ã™ã‚‹ãŸã‚ã€ç„¡æ–™ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚å…¬é–‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ã¿å¯¾å¿œã€‚
                    </p>
                </div>

                <button
                    onclick="loadFromUrl()"
                    id="url-load-btn"
                    class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors font-medium flex items-center gap-2"
                >
                    <span>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’è¡¨ç¤º</span>
                </button>
            </div>

            <!-- Paste Tab -->
            <div id="panel-paste" class="tab-panel hidden">
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <label for="ical-input" class="block text-sm font-medium text-gray-700">
                            iCalãƒ‡ãƒ¼ã‚¿
                        </label>
                        <button
                            onclick="toggleMask()"
                            id="mask-toggle"
                            class="text-xs text-blue-600 hover:text-blue-800 underline"
                        >
                            ğŸ”’ å†…å®¹ã‚’éš ã™
                        </button>
                    </div>
                    <textarea
                        id="ical-input"
                        rows="6"
                        autocomplete="off"
                        data-lpignore="true"
                        data-form-type="other"
                        spellcheck="false"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono text-sm"
                        placeholder="BEGIN:VCALENDAR&#10;VERSION:2.0&#10;..."
                    ></textarea>
                </div>

                <div class="flex gap-3 flex-wrap">
                    <button
                        onclick="loadCalendar()"
                        class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors font-medium"
                    >
                        ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’è¡¨ç¤º
                    </button>
                    <button
                        onclick="exportIcal()"
                        class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors font-medium"
                    >
                        iCalãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜
                    </button>
                    <button
                        onclick="clearData()"
                        class="px-6 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors font-medium"
                    >
                        ã‚¯ãƒªã‚¢
                    </button>
                </div>
            </div>

            <!-- File Upload Tab -->
            <div id="panel-file" class="tab-panel hidden">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        iCalãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                    </label>
                    <input
                        type="file"
                        id="ical-file"
                        accept=".ics,.ical"
                        onchange="handleFileSelect(event)"
                        class="block w-full text-sm text-gray-500
                               file:mr-4 file:py-2 file:px-4
                               file:rounded-md file:border-0
                               file:text-sm file:font-medium
                               file:bg-blue-50 file:text-blue-700
                               hover:file:bg-blue-100"
                    >
                </div>

                <div class="flex gap-3">
                    <button
                        onclick="loadCalendar()"
                        class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors font-medium"
                    >
                        ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’è¡¨ç¤º
                    </button>
                    <button
                        onclick="clearData()"
                        class="px-6 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors font-medium"
                    >
                        ã‚¯ãƒªã‚¢
                    </button>
                </div>
            </div>

            <!-- Instructions -->
            <div class="mt-6 p-4 bg-blue-50 rounded-md">
                <p class="text-sm text-blue-800">
                    <strong>ğŸ’¡ Google Calendarã®å…¬é–‹URLã‚’å–å¾—ã™ã‚‹æ–¹æ³•ï¼š</strong><br>
                    1. Google Calendarã‚’é–‹ã<br>
                    2. ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¨­å®š â†’ ã€Œã‚¢ã‚¯ã‚»ã‚¹æ¨©ã®è¨­å®šã€â†’ã€Œä¸€èˆ¬ã«å…¬é–‹ã™ã‚‹ã€<br>
                    3. ã€Œå…¬é–‹ç”¨ã‚¢ãƒ‰ãƒ¬ã‚¹ã€ã®icalãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼<br>
                    4. ã‚³ãƒ¼ãƒ‰å†…ã® DEFAULT_CALENDAR_URL ã«è²¼ã‚Šä»˜ã‘ã¦å†ãƒ‡ãƒ—ãƒ­ã‚¤
                </p>
            </div>
        </div>

        <!-- Error Message -->
        <div id="error-message" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-md mb-6">
            <p id="error-text"></p>
        </div>

        <!-- Success Message -->
        <div id="success-message" class="hidden bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-md mb-6">
            <p id="success-text"></p>
        </div>

        <!-- Calendar Section -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div id="calendar"></div>
        </div>

        <!-- Event Count -->
        <div id="event-info" class="mt-4 text-sm text-gray-600 hidden">
            è¡¨ç¤ºä¸­ã®ã‚¤ãƒ™ãƒ³ãƒˆæ•°: <span id="event-count" class="font-semibold">0</span> ä»¶
        </div>
    </div>

    <script>
        let calendar = null;
        let currentIcalData = '';

        // ============================================
        // è¨­å®š: ã“ã“ã«ã‚ãªãŸã®Google Calendarå…¬é–‹URLã‚’å…¥åŠ›
        // ============================================
        const DEFAULT_CALENDAR_URL = 'https://calendar.google.com/calendar/ical/kai.tktk62%40gmail.com/public/basic.ics';  // ä¾‹: 'https://calendar.google.com/calendar/ical/xxxxx/public/basic.ics'
        // ============================================

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•çš„ã«èª­ã¿è¾¼ã¿
        document.addEventListener('DOMContentLoaded', function() {
            initCalendar([]);

            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆURLãŒè¨­å®šã•ã‚Œã¦ã„ã‚Œã°è‡ªå‹•èª­ã¿è¾¼ã¿
            if (DEFAULT_CALENDAR_URL) {
                document.getElementById('calendar-url').value = DEFAULT_CALENDAR_URL;
                loadFromUrl();
            }
        });

        /**
         * è¨­å®šãƒ‘ãƒãƒ«ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
         */
        function toggleSettings() {
            const panel = document.getElementById('settings-panel');
            panel.classList.toggle('hidden');
        }

        /**
         * ã‚¿ãƒ–ã‚’åˆ‡ã‚Šæ›¿ãˆ
         */
        function switchTab(tabName) {
            // ã™ã¹ã¦ã®ã‚¿ãƒ–ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });

            // ã™ã¹ã¦ã®ãƒ‘ãƒãƒ«ã‚’éè¡¨ç¤º
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.add('hidden');
            });

            // é¸æŠã—ãŸã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            document.getElementById('tab-' + tabName).classList.remove('border-transparent', 'text-gray-500');
            document.getElementById('tab-' + tabName).classList.add('border-blue-500', 'text-blue-600');

            // é¸æŠã—ãŸãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º
            document.getElementById('panel-' + tabName).classList.remove('hidden');
        }

        /**
         * FullCalendarã‚’åˆæœŸåŒ–
         * @param {Array} events - ã‚¤ãƒ™ãƒ³ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é…åˆ—
         */
        function initCalendar(events) {
            const calendarEl = document.getElementById('calendar');

            if (calendar) {
                calendar.destroy();
            }

            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                views: {
                    timeGridWeek: {
                        titleFormat: { year: 'numeric', month: 'short', day: 'numeric' }
                    }
                },
                slotMinTime: '06:00:00',
                slotMaxTime: '23:00:00',
                allDaySlot: true,
                locale: 'ja',
                firstDay: 1, // æœˆæ›œæ—¥å§‹ã¾ã‚Š
                events: events,
                eventClick: function(info) {
                    alert(
                        'ã‚¿ã‚¤ãƒˆãƒ«: ' + info.event.title + '\n' +
                        'é–‹å§‹: ' + info.event.start.toLocaleString('ja-JP') + '\n' +
                        'çµ‚äº†: ' + (info.event.end ? info.event.end.toLocaleString('ja-JP') : 'çµ‚æ—¥') + '\n' +
                        (info.event.extendedProps.description ? 'è©³ç´°: ' + info.event.extendedProps.description : '')
                    );
                },
                eventTimeFormat: {
                    hour: '2-digit',
                    minute: '2-digit',
                    meridiem: false
                },
                nowIndicator: true,
                height: 'auto'
            });

            calendar.render();
            updateEventCount(events.length);
        }

        /**
         * URLã‹ã‚‰iCalãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦è¡¨ç¤º
         */
        async function loadFromUrl() {
            const url = document.getElementById('calendar-url').value.trim();
            const btn = document.getElementById('url-load-btn');
            const loadingIndicator = document.getElementById('loading-indicator');

            hideMessages();

            if (!url) {
                showError('URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                loadingIndicator.classList.add('hidden');
                return;
            }

            // URLãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (!url.startsWith('https://calendar.google.com/calendar/ical/')) {
                showError('Google Calendarã®ical URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            // ãƒœã‚¿ãƒ³ã‚’ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã«
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> <span>èª­ã¿è¾¼ã¿ä¸­...</span>';

            try {
                // CORSãƒ—ãƒ­ã‚­ã‚·ã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const proxyUrls = [
                    `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
                    `https://corsproxy.io/?${encodeURIComponent(url)}`
                ];

                let icalData = null;
                let lastError = null;

                // è¤‡æ•°ã®ãƒ—ãƒ­ã‚­ã‚·ã‚’è©¦è¡Œ
                for (const proxyUrl of proxyUrls) {
                    try {
                        const response = await fetch(proxyUrl, {
                            method: 'GET',
                            headers: {
                                'Accept': 'text/calendar, text/plain, */*'
                            }
                        });

                        if (response.ok) {
                            icalData = await response.text();
                            break;
                        }
                    } catch (e) {
                        lastError = e;
                        continue;
                    }
                }

                if (!icalData) {
                    throw new Error('CORSãƒ—ãƒ­ã‚­ã‚·ã§ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                }

                // ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œè¨¼
                if (!icalData.includes('BEGIN:VCALENDAR')) {
                    throw new Error('æœ‰åŠ¹ãªiCalãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
                }

                // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¦ãƒ‘ãƒ¼ã‚¹
                currentIcalData = icalData;
                document.getElementById('ical-input').value = icalData;

                // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’è¡¨ç¤º
                parseAndDisplay(icalData);

                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’éè¡¨ç¤º
                loadingIndicator.classList.add('hidden');

                showSuccess('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æ­£å¸¸ã«èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼');

            } catch (error) {
                console.error('Fetch error:', error);
                showError('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚URLãŒæ­£ã—ã„ã‹ã€ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒå…¬é–‹ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                loadingIndicator.classList.add('hidden');
            } finally {
                // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<span>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’è¡¨ç¤º</span>';
                }
            }
        }

        /**
         * iCalãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«è¡¨ç¤º
         */
        function loadCalendar() {
            const icalData = document.getElementById('ical-input').value.trim();

            hideMessages();

            if (!icalData) {
                showError('iCalãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            currentIcalData = icalData;
            parseAndDisplay(icalData);
        }

        /**
         * iCalãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦è¡¨ç¤º
         * @param {string} icalData - iCalå½¢å¼ã®ãƒ‡ãƒ¼ã‚¿
         */
        function parseAndDisplay(icalData) {
            try {
                const jcalData = ICAL.parse(icalData);
                const comp = new ICAL.Component(jcalData);
                const vevents = comp.getAllSubcomponents('vevent');

                const events = [];

                vevents.forEach(function(vevent) {
                    const event = new ICAL.Event(vevent);

                    // ç¹°ã‚Šè¿”ã—ã‚¤ãƒ™ãƒ³ãƒˆã®å‡¦ç†
                    if (event.isRecurring()) {
                        const expand = event.iterator();
                        let next;
                        let count = 0;
                        const maxCount = 100;

                        const startRange = new Date();
                        startRange.setFullYear(startRange.getFullYear() - 1);
                        const endRange = new Date();
                        endRange.setFullYear(endRange.getFullYear() + 1);

                        while ((next = expand.next()) && count < maxCount) {
                            const eventStart = next.toJSDate();

                            if (eventStart > endRange) break;
                            if (eventStart >= startRange) {
                                const duration = event.endDate.toJSDate() - event.startDate.toJSDate();
                                const eventEnd = new Date(eventStart.getTime() + duration);

                                events.push({
                                    title: event.summary || 'ç„¡é¡Œ',
                                    start: eventStart.toISOString(),
                                    end: eventEnd.toISOString(),
                                    description: event.description || '',
                                    location: event.location || '',
                                    allDay: event.startDate.isDate
                                });
                            }
                            count++;
                        }
                    } else {
                        events.push({
                            title: event.summary || 'ç„¡é¡Œ',
                            start: event.startDate.toJSDate().toISOString(),
                            end: event.endDate.toJSDate().toISOString(),
                            description: event.description || '',
                            location: event.location || '',
                            allDay: event.startDate.isDate
                        });
                    }
                });

                if (events.length === 0) {
                    showError('æœ‰åŠ¹ãªã‚¤ãƒ™ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
                    return;
                }

                initCalendar(events);
                showSuccess(events.length + 'ä»¶ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¡¨ç¤ºã—ã¾ã—ãŸã€‚');

            } catch (error) {
                console.error('Parse error:', error);
                showError('iCalãƒ‡ãƒ¼ã‚¿ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        }

        /**
         * ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰iCalãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
         */
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('ical-input').value = e.target.result;
                currentIcalData = e.target.result;
                showSuccess('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚');
                // è‡ªå‹•çš„ã«ã‚¿ãƒ–ã‚’åˆ‡ã‚Šæ›¿ãˆ
                switchTab('paste');
            };
            reader.onerror = function() {
                showError('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            };
            reader.readAsText(file);
        }

        /**
         * iCalãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
         */
        function exportIcal() {
            const icalData = currentIcalData || document.getElementById('ical-input').value.trim();

            if (!icalData) {
                showError('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }

            const blob = new Blob([icalData], { type: 'text/calendar' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = 'calendar.ics';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            URL.revokeObjectURL(url);

            showSuccess('iCalãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚');
        }

        /**
         * å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
         */
        function clearData() {
            if (confirm('å…¥åŠ›ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                document.getElementById('ical-input').value = '';
                document.getElementById('calendar-url').value = '';
                currentIcalData = '';
                initCalendar([]);
                document.getElementById('event-info').classList.add('hidden');
                hideMessages();
            }
        }

        /**
         * ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
         */
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            errorText.textContent = message;
            errorDiv.classList.remove('hidden');

            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 8000);
        }

        /**
         * æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
         */
        function showSuccess(message) {
            const successDiv = document.getElementById('success-message');
            const successText = document.getElementById('success-text');
            successText.textContent = message;
            successDiv.classList.remove('hidden');

            setTimeout(() => {
                successDiv.classList.add('hidden');
            }, 5000);
        }

        /**
         * ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
         */
        function hideMessages() {
            document.getElementById('error-message').classList.add('hidden');
            document.getElementById('success-message').classList.add('hidden');
        }

        /**
         * ã‚¤ãƒ™ãƒ³ãƒˆæ•°ã‚’æ›´æ–°
         */
        function updateEventCount(count) {
            const eventInfo = document.getElementById('event-info');
            const eventCount = document.getElementById('event-count');
            eventCount.textContent = count;
            eventInfo.classList.remove('hidden');
        }

        /**
         * ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®ãƒã‚¹ã‚¯è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
         */
        let isMasked = false;
        function toggleMask() {
            const textarea = document.getElementById('ical-input');
            const toggleBtn = document.getElementById('mask-toggle');

            isMasked = !isMasked;

            if (isMasked) {
                textarea.style.fontFamily = 'password';
                textarea.style.webkitTextSecurity = 'disc';
                toggleBtn.textContent = 'ğŸ‘ï¸ å†…å®¹ã‚’è¡¨ç¤º';
            } else {
                textarea.style.fontFamily = 'monospace';
                textarea.style.webkitTextSecurity = 'none';
                toggleBtn.textContent = 'ğŸ”’ å†…å®¹ã‚’éš ã™';
            }
        }
    </script>
</body>
</html>
